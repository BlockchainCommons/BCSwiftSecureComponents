import XCTest
import WolfBase
import SecureComponents

class CompressedTests: XCTestCase {
    func test1() throws {
        let source = """
            Lorem ipsum dolor sit amet consectetur adipiscing elit mi
            nibh ornare proin blandit diam ridiculus, faucibus mus
            dui eu vehicula nam donec dictumst sed vivamus bibendum
            aliquet efficitur. Felis imperdiet sodales dictum morbi
            vivamus augue dis duis aliquet velit ullamcorper porttitor,
            lobortis dapibus hac purus aliquam natoque iaculis blandit
            montes nunc pretium.
            """.utf8Data
        let compressed = Compressed(uncompressedData: source)
        XCTAssertEqual(compressed†, "Compressed(checksum: 7141b818, size: 222/364, ratio: 0.61, digest: nil)")
        XCTAssertEqual(try compressed.uncompress(), source)
    }
    
    func test2() {
        let source = "Lorem ipsum dolor sit amet consectetur adipiscing".utf8Data
        let compressed = Compressed(uncompressedData: source)
        XCTAssertEqual(compressed†, "Compressed(checksum: 29db1793, size: 47/49, ratio: 0.96, digest: nil)")
        XCTAssertEqual(try compressed.uncompress(), source)
    }
    
    func test3() {
        let source = "Lorem".utf8Data
        let compressed = Compressed(uncompressedData: source)
        XCTAssertEqual(compressed†, "Compressed(checksum: 44989b39, size: 5/5, ratio: 1, digest: nil)")
        XCTAssertEqual(try compressed.uncompress(), source)
    }
    
    func test4() {
        let source = "".utf8Data
        let compressed = Compressed(uncompressedData: source)
        XCTAssertEqual(compressed†, "Compressed(checksum: 00000000, size: 0/0, ratio: NaN, digest: nil)")
        XCTAssertEqual(try compressed.uncompress(), source)
    }
    
    func test5() {
        // This CBOR is encoded based on:
        // https://datatracker.ietf.org/doc/html/draft-ietf-cbor-packed#appendix-A
        // Figures 2-3.
        
        // Before packing: 400 bytes
        // After packing:  310 bytes 76%
        // After DEFLATE:  259 bytes 64%
        let source = ‡"A16573746F7265A264626F6F6B84A46863617465676F7279697265666572656E636566617574686F726A4E6967656C2052656573657469746C6576536179696E6773206F66207468652043656E74757279657072696365FB4021E66666666666A46863617465676F72796766696374696F6E66617574686F726C4576656C796E205761756768657469746C656F53776F7264206F6620486F6E6F7572657072696365FB4029FAE147AE147BA56863617465676F72796766696374696F6E66617574686F726F4865726D616E204D656C76696C6C65657469746C65694D6F6279204469636B646973626E6D302D3535332D32313331312D33657072696365FB4021FAE147AE147BA56863617465676F72796766696374696F6E66617574686F72704A2E20522E20522E20546F6C6B69656E657469746C6575546865204C6F7264206F66207468652052696E6773646973626E6D302D3339352D31393339352D38657072696365FB4036FD70A3D70A3D6762696379636C65A265636F6C6F7263726564657072696365FB4033F33333333333"
        let compressed = Compressed(uncompressedData: source)
        XCTAssertEqual(compressed†, "Compressed(checksum: a5918c46, size: 259/400, ratio: 0.65, digest: nil)")
    }
    
    
    func test6() {
        // This CBOR is encoded based on:
        // https://datatracker.ietf.org/doc/html/draft-ietf-cbor-packed#appendix-A
        // Figures 4-5.
        
        // Before packing: 1210 bytes
        // After packing:   504 bytes 41%
        // After DEFLATE:   321 bytes 26%
        let source = ‡"A6646E616D65654D794C45446C696E746572616374696F6E7386A5656C696E6B7381A264687265667835687474703A2F2F3139322E3136382E312E3130333A383434352F776F742F7468696E672F4D794C45442F72676256616C7565526564696D6564696154797065706170706C69636174696F6E2F6A736F6E6A6F757470757444617461A16976616C756554797065A16474797065666E756D626572646E616D656B72676256616C7565526564687772697461626C65F5654074797065816850726F7065727479A5656C696E6B7381A264687265667837687474703A2F2F3139322E3136382E312E3130333A383434352F776F742F7468696E672F4D794C45442F72676256616C7565477265656E696D6564696154797065706170706C69636174696F6E2F6A736F6E6A6F757470757444617461A16976616C756554797065A16474797065666E756D626572646E616D656D72676256616C7565477265656E687772697461626C65F5654074797065816850726F7065727479A5656C696E6B7381A264687265667836687474703A2F2F3139322E3136382E312E3130333A383434352F776F742F7468696E672F4D794C45442F72676256616C7565426C7565696D6564696154797065706170706C69636174696F6E2F6A736F6E6A6F757470757444617461A16976616C756554797065A16474797065666E756D626572646E616D656C72676256616C7565426C7565687772697461626C65F5654074797065816850726F7065727479A5656C696E6B7381A264687265667837687474703A2F2F3139322E3136382E312E3130333A383434352F776F742F7468696E672F4D794C45442F72676256616C75655768697465696D6564696154797065706170706C69636174696F6E2F6A736F6E6A6F757470757444617461A16976616C756554797065A16474797065666E756D626572646E616D656D72676256616C75655768697465687772697461626C65F5654074797065816850726F7065727479A5656C696E6B7381A264687265667832687474703A2F2F3139322E3136382E312E3130333A383434352F776F742F7468696E672F4D794C45442F6C65644F6E4F6666696D6564696154797065706170706C69636174696F6E2F6A736F6E6A6F757470757444617461A16976616C756554797065A1647479706567626F6F6C65616E646E616D65686C65644F6E4F6666687772697461626C65F5654074797065816850726F7065727479A4656C696E6B7381A264687265667841687474703A2F2F3139322E3136382E312E3130333A383434352F776F742F7468696E672F4D794C45442F636F6C6F7254656D70657261747572654368616E676564696D6564696154797065706170706C69636174696F6E2F6A736F6E6A6F757470757444617461A16976616C756554797065A16474797065666E756D626572646E616D6577636F6C6F7254656D70657261747572654368616E67656465407479706581654576656E74654074797065644C616D70626964613064626173657823687474703A2F2F3139322E3136382E312E3130333A383434352F776F742F7468696E676840636F6E746578747837687474703A2F2F3139322E3136382E312E3130323A383434342F776F742F7733632D776F742D74642D636F6E746578742E6A736F6E6C64"
        let compressed = Compressed(uncompressedData: source)
        XCTAssertEqual(compressed†, "Compressed(checksum: f032eda3, size: 321/1210, ratio: 0.27, digest: nil)")
    }
}
